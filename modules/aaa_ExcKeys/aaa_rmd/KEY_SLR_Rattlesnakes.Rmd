---
title: "Exercise Key"
subtitle: "Simple Linear Regression"
author: Derek H. Ogle
layout: page
css: "/css/modules.css"
output:
  html_document:
    fig_height: 3.5
    fig_width: 3.5
    self_contained: false
---

```{r echo=FALSE, eval=FALSE, warning=FALSE}
## Renders an appropriate HTML file and moves to CE directory
source("modules/aaa_ExcKeys/aaa_rmd/zzz_modHTML_CEKeys.R")
modHTML_CEKeys("KEY_SLR_Rattlesnakes")
```

```{r echo=FALSE, results='hide', fig.show='hide', message=FALSE, warning=FALSE}
library(NCStats)
source("../../../rhelpers/knitr_setup.R")

rdf <- read.csv("https://raw.githubusercontent.com/droglenc/NCData/master/Rattlesnakes.csv")
lm1 <- lm(freq~weight,data=rdf)
ad1 <- adTest(lm1$residuals)
out1 <- outlierTest(lm1)
rdf$logw <- log(rdf$weight)
rdf$logf <- log(rdf$freq)
lm2 <- lm(logf~logw,data=rdf)
ad2 <- adTest(lm2$residuals)
out2 <- outlierTest(lm2)
aov2 <- anova(lm2)
sum2 <- summary(lm2)
ci2 <- confint(lm2)
p.logf <- predict(lm2,data.frame(logw=log(454)),interval="confidence")
p.freq <- exp(p.logf)*exp(anova(lm2)[2,3]/2)

library(captioner)
tbls <- captioner(prefix="Table")
figs <- captioner(prefix="Figure")
tbls(name="aov","ANOVA table for the linear regression of log-transformed peak frequency of rattles on log-transformed weight of Rattlesnakes.")
figs(name="residPlot1","Histogram of residuals (left) and residual plot (right) for regression of peak frequency of rattles on weight of Rattlesnakes.")
figs(name="residPlot2","Histogram of residuals (left) and residual plot (right) for regression of log-transformed peak frequency of rattles on log-transformed weight of Rattlesnakes.")
figs(name="fitplot","ANOVA table for the linear regression of log-transformed peak frequency of rattles on log-transformed weight of Rattlesnakes.")
```

----

<div class="alert alert-warning">
<strong>Note:</strong> 
<ul>
  <li>There are no "groups" in simple linear regression; thus, you do not assess "within-" and "among-group" independence here.</li>
  <li>You should begin to use the ANOVA table p-value rather than the summary table slope p-value to assess the relationship as this will generalize to the next module.</li>
  <li>When describing the relationship, use the confidence interval for the slope. Don't just use the slope.</li>
  <li>When back-transforming the slope to describe the relationship on the original scale, note that "a change in log(x) of 1" should be back-transformed to "a change in x of e<sup>1</sup>" which is where the 2.72 in answer 4 below came from. Also, note that the back-transformed slope indicates a "multiplicative" change such that the value is Y is multiplied by the back-transformed slope rather than added to.
  <li>The predictions should use prediction intervals as the original authors were interested in predicting the weight of an individual bear.</li>
</ul>
</div>

----

## Rattlesnake Rattling
1. It is difficult to ultimately assess independence with the amount of information given. However, under the assumption that all Rattlesnakes were unique (no snake was measured twice) then it seems that the data are at least roughly independent. There is evidence for a strong non-linearity and heteroscedasticity (`r figs("residPlot1",display="cite")`-Right), the residuals do not appear to be normal (Anderson Darling `r kPvalue(ad1$p,digits=4,latex=FALSE)`) and are right-skewed (`r figs("residPlot1",display="cite")`-Left), and significant outliers are evident (outlier test `r kPvalue(out1$bonf.p,digits=4,latex=FALSE)`). A transformation will be explored to see if the assumptions can be met.

1. The authors suggested that the relationship would be exponential but logging just the peak frequency of the rattle variable did not result in meeting all of the assumptions. However, when both variables were log-transformed there is no visual evidence for non-linearity (`r figs("residPlot1",display="cite")`-Right), the residuals appear roughly homoscedastic (`r figs("residPlot1",display="cite")`-Right) and approximately normal (Anderson-Darling `r kPvalue(ad2$p,digits=4,latex=FALSE)`; `r figs("residPlot1",display="cite")`-Left), and there is no evidence for significant outliers (outlier test `r kPvalue(out2$bonf.p,digits=4,latex=FALSE)`). Thus, the assumptions appear to be adequately met on the log-log scale.

1. There is a signficant relationship between log peak frequency of the rattle and log weight of Rattlesnakes (`r kPvalue(aov2[1,"Pr(>F)"],digits=4,latex=FALSE)`; `r tbls("aov",display="cite")`;  `r figs("fitplot",display="cite")`).

1. Specifically, as the log weight of the Rattlesnakes increases by one unit, the average log peak frequency of the rattle *decreases* between `r formatC(-ci2["logw",2],format="f",digits=3)` and `r formatC(-ci2["logw",1],format="f",digits=3)` units. On the original scale, as the weight of the Rattlesnake increases by a multiple of `r formatC(exp(1),format="f",digits=2)` cm, the average peak frequency of the rattle changes (decreases) by a multiple of between `r formatC(exp(ci2["logw",1]),format="f",digits=3)` and `r formatC(exp(ci2["logw",2]),format="f",digits=3)`.

1. The predicted mean peak frequency for all 454 g Rattlesnake is between `r formatC(p.freq[1,"lwr"],format="f",digits=2)` and `r formatC(p.freq[1,"upr"],format="f",digits=2)` kg.

&nbsp;


```{r echo=FALSE, fig.width=7, fig.height=3.5, par1=TRUE}
NCStats:::iAssumPlot_REGRESS(NCStats:::iTypeoflm(lm1),
                             lambday=1,shifty=0,lambdax=1,shiftx=0,
                             show.stats=TRUE,alpha=0.05,col.hist="gray70")
```

`r figs("residPlot1")`

```{r echo=FALSE, fig.width=7, fig.height=3.5, par1=TRUE}
NCStats:::iAssumPlot_REGRESS(NCStats:::iTypeoflm(lm1),
                             lambday=0,shifty=0,lambdax=0,shiftx=0,
                             show.stats=TRUE,alpha=0.05,col.hist="gray70")
```

`r figs("residPlot2")`

```{r echo=FALSE, fig.width=3.5, fig.height=3.5, par1=TRUE}
fitPlot(lm2,xlab="Log(Length (cm))",ylab="Log(Weight (kg))")
```

`r figs("fitplot")`

`r tbls("aov")`

```{r echo=FALSE,background="white"}
kANOVA(lm1)
```

`r tbls("preds")`

```{r echo=FALSE,background="white"}
print(p.weight,row.names=FALSE)
```

R Appendix.
```{r eval=FALSE, prompt=FALSE}
bb <- read.csv("BlackBears.csv")
bb <- filterD(bb,age>1)
lm1 <- lm(weight~length,data=bb)
transChooser(lm1)
bb$logw <- log(bb$weight)
bb$logl <- log(bb$length)
lm2 <- lm(logw~logl,data=bb)
transChooser(lm2)
anova(lm2)
cbind(Ests=coef(lm2),confint(lm2))
lens <- c(130,160,190)
nd <- data.frame(logl=log(lens))
p.logw <- predictionPlot(lm2,nd,interval="prediction")
p.weight <- exp(p.logw[,3:5])*exp(anova(lm2)[2,3]/2)
```

----
