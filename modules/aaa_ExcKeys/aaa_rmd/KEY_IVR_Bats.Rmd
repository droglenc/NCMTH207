---
title: "Exercise Key"
subtitle: "Indicator Variable Regression"
author: Derek H. Ogle
layout: page
css: "/css/modules.css"
output:
  html_document:
    fig_height: 3.5
    fig_width: 3.5
    self_contained: false
---

```{r echo=FALSE, eval=FALSE, warning=FALSE}
## Renders an appropriate HTML file and moves to CE directory
source("modules/aaa_ExcKeys/aaa_rmd/zzz_modHTML_CEKeys.R")
modHTML_CEKeys("KEY_IVR_Bats")
```
```{r echo=FALSE, include=FALSE, message=FALSE, warning=FALSE}
library(NCStats)

b <- read.csv("https://raw.githubusercontent.com/droglenc/NCData/master/Batmorph2.csv")
b <- filterD(b,diet!="vampire")
b$diet <- relevel(b$diet,"phytophage")
lm1 <- lm(audnuc~bodywt*diet,data=b)
ad1 <- adTest(lm1$residuals)
out1 <- outlierTest(lm1)
b$logaudnuc <- log(b$audnuc)
b$logbodywt <- log(b$bodywt)
lm2 <- lm(logaudnuc~logbodywt*diet,data=b)
ad2 <- adTest(lm2$residuals)
out2 <- outlierTest(lm2)
aov2 <- anova(lm2)
lm3 <- lm(logaudnuc~logbodywt,data=b)
cis3 <- confint(lm3)

library(captioner)
tbls <- captioner(prefix="Table")
figs <- captioner(prefix="Figure")
tbls(name="aov","ANOVA table for the indicator variable regression of log-transformed auditory nuclei volume on log-transformed bat body weight for three different diet groups.")
figs(name="residPlot1","Histogram of residuals (left) and residual plot (right) for indicator variable regression of auditory nuclei volume on bat body weight for three different diet groups.")
figs(name="residPlot2","Histogram of residuals (left) and residual plot (right) for indicator variable regression of log-transformed auditory nuclei volume on log-transformed bat body weight for three different diet groups.")
figs(name="fitplot","Scatterplot of log-transformed auditory nuclei volume on log-transformed bat body weight for three different diet groups with best-fit lines.")

```

----

<div class="alert alert-warning">
<strong>Note:</strong> 
<ul>
  <li>The indicator variable is named after the "1" group. The reference group will not be explicitly stated in the indicator variables, but is defined when all indicator variables are 0.</li>
  <li>The variables are entered into the ultimate full model in this order -- covariate, all indicator variables, and all interaction variables.</li>
  <li>The submodel for the "1-day starved" group is found by plugging in 0 for ALL indicatory variables and then simplifying. Essentially everything in the ultimate full model multiplied by an indicator variable is dropped.</li>
  <li>The submodel for the "4-day starve" group is found by plugging in 1 for FOUR and 0 for the other indicator variables and then simplifying. Essentially everything in the ultimate full model multiplied by one of the other indicator variable is dropped. Additionally, the word FOUR is dropped and then the two constants (&alpha; and &delta;<sub>1</sub>) are lumped together and the two items multiplied by the covariate (&beta; and &gamma;<sub>1</sub>) are lumped together. A similar argument is made for the other groups.</li>
</ul>
</div>

----

## Bat Morphology

1. As there are three groups in this analysis and the "phytophagous" bats are to be the reference group, I created the following two indicator variables.
    * AI=1 if in the "aerial insectivor" group, 0 otherwise
    * G=1 if in the "gleaner" group, 0 otherwise
    
    The ultimate full model is then &mu;<sub>ANV</sub> = &alpha; + &beta;WT + &delta;<sub>1</sub>AI + &delta;<sub>2</sub>G + &gamma;<sub>1</sub>AI&times;WT + &gamma;<sub>2</sub>G&times;WT, where ANV is "auditory nuclei volume" and WT is "body weight" of the bats.
1. The submodels for all three groups are below.
    * phytophagous: &mu;<sub>ANV</sub> = &alpha; + &beta;WT
    * aerial insectivor: &mu;<sub>ANV</sub> = (&alpha;+&delta;<sub>1</sub>) + (&beta;+&gamma;<sub>1</sub>)WT
    * gleaner: &mu;<sub>ANV</sub> = (&alpha;+&delta;<sub>2</sub>) + (&beta;+&gamma;<sub>3</sub>)WT
1. The data appear to be independent as each individual is a separate species and no species is simultaneously grouped into two diet categories. There is some evidence for a slight non-linearity within the groups (`r figs("residPlot1",display="cite")`-Right). The residual plot (`r figs("residPlot1",display="cite")`-Right) also suggests heteroscedasticity. The residuals do not appear to be normal (Anderson Darling `r kPvalue(ad1$p,digits=4,latex=FALSE)`) and are right-skewed (`r figs("residPlot1",display="cite")`-Left). There appears to be a significant outlier (outlier test `r kPvalue(out1$bonf.p,digits=4,latex=FALSE)`).
    
    A trial-and-error method (i.e., use of `transChooser`) was used to determine that the auditory nuclei mass variable should be transformed with the natural logarithm. In addition, although the maximum to minimum ratio does not warrant it and none of the major regression assumptions are violated without it, the model appears to have no influential observations if the body weight variable is also transformed with natural logarithms. With both variables transformed to the natural log scale, the model appeared linear within the groups (`r figs("residPlot2",display="cite")`-Left), the residuals were homoscedastic (`r figs("residPlot2",display="cite")`-Right) and normal (Anderson Darling `r kPvalue(ad2$p,digits=4,latex=FALSE)`; `r figs("residPlot2",display="cite")`-Left), and there were no outlies (outlier test `r kPvalue(out2$bonf.p,digits=4,latex=FALSE)`). Thus, the assumptions were adequately met on the log-log scale and all further analyses were conducted on this scale.
    
1. The slopes between log auditory nuclei mass and log body weight were statistically similar among the three diet groups (`r kPvalue(aov2["logbodywt:diet","Pr(>F)"],digits=4,latex=FALSE)`; `r tbls("aov",display="cite")`); thus, the lines that describe the relationship between log auditory nuclei mass and log body weight for the separate groups of bats are all parallel.

1. The intercepts (assuming parallel lines) for the lines describing the relationship between log auditory nuclei mass and log body weight were statistically similar among the three diet groups (`r kPvalue(aov2["diet","Pr(>F)"],digits=4,latex=FALSE)`; `r tbls("aov",display="cite")`); thus, the lines all have the same intercept. Coupled with the observation that the lines were parallel, this result indicates that the lines are coincident among the three groups.

1. A plot that illustrates the model fit is in `r figs("fitplot",display="cite")`.

1. The results of the previous analysis show that the relationship between log auditory nuclei mass and log body weight can be modeled by the same line for each of the three different diet groups `r figs("fitplot",display="cite")`. In other words, there was no difference in the relationship between log auditory nuclei mass and log body weight among the three diet groups. In addition, at any given log body weight there was no difference in log auditory nuclei mass among the three groups. There was, however, a significant positive relationship between log auditory nuclei mass and log body weight. In fact, it appears that as the log body weight increases by 1 g, the log auditory nuclei volume will increase between `r formatC(cis3[2,1],format="f",digits=2)` and `r formatC(cis3[2,2],format="f",digits=2)` mm<sup>3</sup>.


```{r echo=FALSE, fig.width=7, fig.height=3.5, par1=TRUE}
NCStats:::iAssumPlot_REGRESS(NCStats:::iTypeoflm(lm1),
                             lambday=1,shifty=0,lambdax=1,shiftx=0,
                             show.stats=TRUE,alpha=0.05,col.hist="gray70")
```

`r figs("residPlot1")`

```{r echo=FALSE, fig.width=7, fig.height=3.5, par1=TRUE}
NCStats:::iAssumPlot_REGRESS(NCStats:::iTypeoflm(lm1),
                             lambday=0,shifty=0,lambdax=0,shiftx=0,
                             show.stats=TRUE,alpha=0.05,col.hist="gray70")
```

`r figs("residPlot2")`

```{r echo=FALSE, fig.width=3.5, fig.height=3.5, par1=TRUE}
fitPlot(lm2,xlab="Log(Body Weight (g))",
        ylab="Log(Auditory Nuclei Volume (mm^3))",
        legend="topleft")
```

`r figs("fitplot")`

`r tbls("aov")`

```{r echo=FALSE,background="white"}
kANOVA(lm2)
```

R Appendix.
```{r eval=FALSE, prompt=FALSE}
b <- read.csv("Batmorph2.csv")
b <- filterD(b,diet!="vampire")
b$diet <- relevel(b$diet,"phytophage")
lm1 <- lm(audnuc~bodywt*diet,data=b)
transChooser(lm1)
b$logaudnuc <- log(b$audnuc)
b$logbodywt <- log(b$bodywt)
lm2 <- lm(logaudnuc~logbodywt*diet,data=b)
anova(lm2)
fitPlot(lm2,xlab="Log(Body Weight (g))",
        ylab="Log(Auditory Nuclei Volume (mm^3))",
        legend="topleft")
lm3 <- lm(logaudnuc~logbodywt,data=b)
confint(lm3)
```


----
